# ============================================
# AutoCognitix - Traefik Dynamic Configuration
# Middlewares, TLS options, and security settings
# ============================================

# ==========================================
# HTTP Configuration
# ==========================================
http:
  # ========================================
  # Middlewares
  # ========================================
  middlewares:
    # Security Headers
    security-headers:
      headers:
        # HSTS (HTTP Strict Transport Security)
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true

        # Prevent clickjacking
        frameDeny: true

        # Prevent MIME type sniffing
        contentTypeNosniff: true

        # XSS Protection
        browserXssFilter: true

        # Referrer Policy
        referrerPolicy: "strict-origin-when-cross-origin"

        # Content Security Policy
        contentSecurityPolicy: >-
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval';
          style-src 'self' 'unsafe-inline';
          img-src 'self' data: https:;
          font-src 'self' data:;
          connect-src 'self' https:;
          frame-ancestors 'self';
          base-uri 'self';
          form-action 'self';

        # Permissions Policy
        permissionsPolicy: >-
          accelerometer=(),
          camera=(),
          geolocation=(),
          gyroscope=(),
          magnetometer=(),
          microphone=(),
          payment=(),
          usb=()

        # Custom headers
        customResponseHeaders:
          X-Robots-Tag: "noindex, nofollow, nosnippet, noarchive"
          Server: ""

    # Rate Limiting - General
    rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: 1m
        sourceCriterion:
          ipStrategy:
            depth: 1

    # Rate Limiting - Strict (for auth endpoints)
    rate-limit-strict:
      rateLimit:
        average: 10
        burst: 20
        period: 1m
        sourceCriterion:
          ipStrategy:
            depth: 1

    # Rate Limiting - API
    rate-limit-api:
      rateLimit:
        average: 60
        burst: 100
        period: 1m
        sourceCriterion:
          ipStrategy:
            depth: 1

    # Retry middleware for backend
    retry-backend:
      retry:
        attempts: 3
        initialInterval: 100ms

    # Circuit Breaker
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.30 || ResponseCodeRatio(500, 600, 0, 600) > 0.25"

    # Compress middleware
    compress:
      compress:
        excludedContentTypes:
          - text/event-stream

    # Strip prefix for API versioning
    strip-api-prefix:
      stripPrefix:
        prefixes:
          - "/api"

    # Add trailing slash
    add-trailing-slash:
      redirectRegex:
        regex: "^(https?://[^/]+/[a-zA-Z0-9_-]+)$"
        replacement: "${1}/"
        permanent: true

    # IP Whitelist for dashboard (example)
    dashboard-whitelist:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"

    # Basic Auth for dashboard
    dashboard-auth:
      basicAuth:
        # Generate with: htpasswd -nb admin <password>
        # Default: admin:admin (CHANGE IN PRODUCTION!)
        users:
          - "admin:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/"

    # In-flight request limiter
    in-flight-limit:
      inFlightReq:
        amount: 100
        sourceCriterion:
          ipStrategy:
            depth: 1

    # Request body size limit
    body-limit:
      buffering:
        maxRequestBodyBytes: 10485760  # 10MB
        memRequestBodyBytes: 2097152   # 2MB
        maxResponseBodyBytes: 0
        retryExpression: "IsNetworkError() && Attempts() < 2"

  # ========================================
  # Routers (examples - actual routes in docker-compose labels)
  # ========================================
  routers:
    # Dashboard router
    traefik-dashboard:
      rule: "Host(`traefik.${DOMAIN}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      entryPoints:
        - websecure
      service: api@internal
      middlewares:
        - dashboard-whitelist
        - dashboard-auth
        - security-headers
      tls:
        certResolver: letsencrypt

# ==========================================
# TLS Configuration
# ==========================================
tls:
  options:
    default:
      minVersion: VersionTLS12
      maxVersion: VersionTLS13
      cipherSuites:
        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
      curvePreferences:
        - CurveP521
        - CurveP384
      sniStrict: true

    # Modern TLS 1.3 only option
    modern:
      minVersion: VersionTLS13
      sniStrict: true

# ==========================================
# TCP Configuration (if needed)
# ==========================================
tcp:
  routers: {}
  services: {}
