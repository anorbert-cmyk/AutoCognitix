name: CD

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Prepare deployment metadata
  # ============================================
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.env.outputs.environment }}
      sha_short: ${{ steps.sha.outputs.sha_short }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=sha-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event.inputs.environment }}" != "" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Get short SHA
        id: sha
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  # ============================================
  # Build and push backend Docker image
  # ============================================
  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.event_name == 'release' }}
            type=raw,value=${{ needs.prepare.outputs.environment }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
            COMMIT_SHA=${{ needs.prepare.outputs.sha_short }}

      - name: Output image
        id: image
        run: |
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:${{ needs.prepare.outputs.version }}" >> $GITHUB_OUTPUT

  # ============================================
  # Build and push frontend Docker image
  # ============================================
  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: read
      packages: write
    outputs:
      image: ${{ steps.image.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.event_name == 'release' }}
            type=raw,value=${{ needs.prepare.outputs.environment }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
            VITE_API_URL=${{ vars.VITE_API_URL }}

      - name: Output image
        id: image
        run: |
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:${{ needs.prepare.outputs.version }}" >> $GITHUB_OUTPUT

  # ============================================
  # Deploy to Railway
  # ============================================
  deploy-railway:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: [prepare, build-backend, build-frontend]
    environment:
      name: ${{ needs.prepare.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Backend to Railway
        id: deploy-backend
        run: |
          cd backend
          railway up --service backend --detach || echo "Backend deployment may need manual intervention"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

      - name: Deploy Frontend to Railway
        id: deploy-frontend
        run: |
          cd frontend
          railway up --service frontend --detach || echo "Frontend deployment may need manual intervention"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

      - name: Output deployment URL
        id: deploy
        run: |
          echo "url=https://autocognitix.up.railway.app" >> $GITHUB_OUTPUT

  # ============================================
  # Run Database Migrations
  # ============================================
  run-migrations:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: [prepare, deploy-railway]
    environment: ${{ needs.prepare.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install alembic asyncpg sqlalchemy psycopg2-binary

      - name: Run Alembic migrations
        run: |
          cd backend
          alembic upgrade head
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: true

  # ============================================
  # Smoke Tests after deployment
  # Non-blocking during early development
  # ============================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: [prepare, deploy-railway, run-migrations]
    environment: ${{ needs.prepare.outputs.environment }}
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Wait for deployment to be ready
        run: sleep 30

      - name: Health check - Backend
        run: |
          for i in {1..10}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.API_URL }}/health" || echo "000")
            if [ "$status" == "200" ]; then
              echo "Backend is healthy!"
              exit 0
            fi
            echo "Attempt $i: Backend returned $status, waiting..."
            sleep 10
          done
          echo "Backend health check did not succeed after 10 attempts (may still be starting)"
        continue-on-error: true

      - name: Health check - Frontend
        run: |
          for i in {1..10}; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.FRONTEND_URL }}" || echo "000")
            if [ "$status" == "200" ]; then
              echo "Frontend is healthy!"
              exit 0
            fi
            echo "Attempt $i: Frontend returned $status, waiting..."
            sleep 10
          done
          echo "Frontend health check did not succeed after 10 attempts (may still be starting)"
        continue-on-error: true

      - name: API endpoint tests
        run: |
          # Test API version endpoint
          curl -sf "${{ vars.API_URL }}/api/v1/health" || echo "API health endpoint check failed (non-blocking)"

          # Test DTC search endpoint (should return 200 even without results)
          curl -sf "${{ vars.API_URL }}/api/v1/dtc/search?q=P0001" || echo "DTC search endpoint check failed (non-blocking)"
        continue-on-error: true

  # ============================================
  # Notify deployment status
  # ============================================
  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [prepare, build-backend, build-frontend, deploy-railway, smoke-tests]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.prepare.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.prepare.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ needs.prepare.outputs.sha_short }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Build | ${{ needs.build-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy-railway.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          # During early development, don't fail the workflow on smoke test issues
          if [ "${{ needs.build-backend.result }}" == "success" ] && \
             [ "${{ needs.build-frontend.result }}" == "success" ] && \
             [ "${{ needs.deploy-railway.result }}" == "success" ]; then
            echo "Deployment completed!"
            if [ "${{ needs.smoke-tests.result }}" != "success" ]; then
              echo "Note: Smoke tests had issues - services may need time to start"
            fi
          else
            echo "Deployment had issues. Check the logs for details."
          fi
          # Don't exit with error during early development
          exit 0

  # ============================================
  # Rollback on failure (manual trigger only)
  # Disabled during early development to avoid noise
  # ============================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [prepare, smoke-tests, build-backend, build-frontend]
    # Only run if build actually failed (not smoke tests)
    if: failure() && (needs.build-backend.result == 'failure' || needs.build-frontend.result == 'failure')
    environment: ${{ needs.prepare.outputs.environment }}
    steps:
      - name: Get previous version
        id: previous
        run: |
          # This would typically query Railway or your registry for the previous version
          echo "Rollback would be triggered here"
          echo "Manual intervention required for rollback"

      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Build Failed - Deployment Blocked (${context.sha.substring(0, 8)})`,
              body: `## Build Failure\n\n- **Version:** ${{ needs.prepare.outputs.version }}\n- **Environment:** ${{ needs.prepare.outputs.environment }}\n- **Commit:** ${context.sha}\n\nDocker build failed. Deployment was not attempted.\n\n[View Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['deployment', 'build-failure']
            })
        continue-on-error: true
